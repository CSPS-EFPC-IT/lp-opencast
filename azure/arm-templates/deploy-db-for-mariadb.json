{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "databaseServerAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password of the Database Server Administrator."
            }
        },
        "databaseServerAdminUsername": {
            "type": "securestring",
            "metadata": {
                "description": "The username of the Database Server Administrator."
            }
        },
        "databaseServerBackupRetentionDays": {
            "type": "int",
            "minValue": 7,
            "maxValue": 35,
            "defaultValue": 7,
            "metadata": {
                "description": "The Database Server backup retention period in days."
            }
        },
        "databaseServerCapacity": {
            "type": "int",
            "allowedValues": [ 2, 4, 8, 16, 32, 64 ],
            "defaultValue": 2,
            "metadata": {
                "description": "The number of vCPUs allocated to the Database Server."
            }
        },
        "databaseServerConfigurationAuditLogEnabled": {
            "type": "string",
            "defaultValue": "On",
            "allowedValues": [
                "Off",
                "On"
            ],
            "metadata": {
                "description": "The value of the Database Server parameter \"audit_log_enabled\"."
            }
        },
        "databaseServerConfigurationAuditLogEvents": {
            "type": "string",
            "defaultValue": "ADMIN,CONNECTION,DCL,DDL,DML,GENERAL",
            "metadata": {
                "description": "The value of the Database Server parameter \"audit_log_events\"."
            }
        },
        "databaseServerConfigurationCharacterSetServer": {
            "type": "string",
            "defaultValue": "utf8mb4",
            "metadata": {
                "description": "The value of the Database Server parameter \"character_set_server\"."
            }
        },
        "databaseServerConfigurationCollationServer": {
            "type": "string",
            "defaultValue": "utf8mb4_unicode_ci",
            "metadata": {
                "description": "The value of the Database Server parameter \"collation_server\"."
            }
        },
        "databaseServerName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Database Server resource."
            }
        },
        "databaseServerPublicNetworkAccess": {
            "type": "string",
            "defaultValue": "Enabled",
            "allowedValues": [
                "Disabled",
                "Enabled"
            ],
            "metadata": {
                "description": "Whether or not the Database Server should be reachable from Public Networks."
            }
        },
        "databaseServerStorageMb": {
            "type": "int",
            "minValue": 102400,
            "maxValue": 16777216,
            "defaultValue": 102400,
            "metadata": {
                "description": "The size of the data storage allocated to the Database Server in MB."
            }
        },
        "databaseServerVersion": {
            "type": "string",
            "defaultValue": "10.3",
            "allowedValues": [ "10.2", "10.3" ],
            "metadata": {
                "description": "The version of the Database Server to deploy."
            }
        },
        "locationName": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "The name of the Azure Location where resources will be created."
            }
        },
        "logAnalyticsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Log Analytics Workspace resource used by the Database Server."
            }
        },
        "logAnalyticsWorkspaceResourceGroupName": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "The name of the Resource Group holding the Log Analytics Workspace."
            }
        },
        "logAnalyticsWorkspaceSubscriptionId": {
            "type": "string",
            "defaultValue": "[subscription().subscriptionId]",
            "metadata": {
                "description": "The Subscription ID of the Log Analytics Workspace resource used by the Database Server."
            }
        },
        "resourceTags": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Generic tags for any resources."
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "not provided",
            "metadata": {
                "description": "The name of the Virtual Network connected to the Database Server, if any. Omit this parameter if the Database Server Public Network Access is disabled."
            }
        },
        "virtualNetworkResourceGroupName": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "The name of the Resource Group containing the Virtual Network connected to the Database Server, if any."
            }
        },
        "virtualNetworkSubnetName": {
            "type": "string",
            "defaultValue": "not provided",
            "metadata": {
                "description": "The name of the Virtual Network Subnet connected to the Database Server, if any. Omit this parameter if the Database Server Public Network Access is disabled."
            }
        },
        "virtualNetworkSubscriptionId": {
            "type": "string",
            "defaultValue": "[subscription().subscriptionId]",
            "metadata": {
                "description": "The Subscription ID containing the Virtual Network connected to the Database Server, if any."
            }
        }
    },
    "functions": [],
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.DBforMariaDB/servers",
            "apiVersion": "2018-06-01",
            "name": "[parameters('databaseServerName')]",
            "tags": "[parameters('resourceTags')]",
            "location": "[parameters('locationName')]",
            "sku": {
                "name": "[concat('GP_Gen5_', parameters('databaseServerCapacity'))]",
                "tier": "GeneralPurpose",
                "family": "Gen5",
                "capacity": "[parameters('databaseServerCapacity')]"
            },
            "properties": {
                "storageProfile": {
                    "storageMB": "[parameters('databaseServerStorageMb')]",
                    "backupRetentionDays": "[parameters('databaseServerBackupRetentionDays')]",
                    "geoRedundantBackup": "Enabled",
                    "storageAutogrow": "Enabled"
                },
                "version": "[parameters('databaseServerVersion')]",
                "sslEnforcement": "Enabled",
                "minimalTlsVersion": "TLS1_2",
                "infrastructureEncryption": "Disabled",
                "publicNetworkAccess": "[parameters('databaseServerPublicNetworkAccess')]",
                "createMode": "Default",
                "administratorLogin": "[parameters('databaseServerAdminUsername')]",
                "administratorLoginPassword": "[parameters('databaseServerAdminPassword')]"
            }
        },
        {
            "type": "Microsoft.DBforMariaDB/servers/configurations",
            "apiVersion": "2018-06-01",
            "name": "[concat(parameters('databaseServerName'), '/audit_log_enabled')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMariaDB/servers', parameters('databaseServerName'))]"
            ],
            "properties": {
                "value": "[parameters('databaseServerConfigurationAuditLogEnabled')]",
                "source": "user-override"
            }
        },
        {
            "type": "Microsoft.DBforMariaDB/servers/configurations",
            "apiVersion": "2018-06-01",
            "name": "[concat(parameters('databaseServerName'), '/audit_log_events')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMariaDB/servers', parameters('databaseServerName'))]"
            ],
            "properties": {
                "value": "[parameters('databaseServerConfigurationAuditLogEvents')]",
                "source": "user-override"
            }
        },
        {
            "type": "Microsoft.DBforMariaDB/servers/configurations",
            "apiVersion": "2018-06-01",
            "name": "[concat(parameters('databaseServerName'), '/character_set_server')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMariaDB/servers', parameters('databaseServerName'))]"
            ],
            "properties": {
                "value": "[parameters('databaseServerConfigurationCharacterSetServer')]",
                "source": "user-override"
            }
        },
        {
            "type": "Microsoft.DBforMariaDB/servers/configurations",
            "apiVersion": "2018-06-01",
            "name": "[concat(parameters('databaseServerName'), '/collation_server')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMariaDB/servers', parameters('databaseServerName'))]"
            ],
            "properties": {
                "value": "[parameters('databaseServerConfigurationCollationServer')]",
                "source": "user-override"
            }
        },
        {
            "type": "Microsoft.DBforMariaDB/servers/virtualNetworkRules",
            "apiVersion": "2018-06-01",
            "name": "[concat(parameters('databaseServerName'), '/', parameters('virtualNetworkSubnetName'))]",
            "condition": "[and(equals(parameters('databaseServerPublicNetworkAccess'), 'Enabled'), not(equals(parameters('virtualNetworkName'), 'not provided')), not(equals(parameters('virtualNetworkSubnetName'), 'not provided')))]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMariaDB/servers', parameters('databaseServerName'))]"
            ],
            "properties": {
                "virtualNetworkSubnetId": "[resourceId(parameters('virtualNetworkSubscriptionId'), parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('virtualNetworkSubnetName'))]",
                "ignoreMissingVnetServiceEndpoint": false
            }
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "name": "local-logging",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMariaDB/servers', parameters('databaseServerName'))]"
            ],
            "scope": "[concat('Microsoft.DBforMariaDB/servers', '/', parameters('databaseServerName'))]",
            "properties": {
                "logs": [
                    {
                        "categoryGroup": "AllLogs",
                        "enabled": true,
                        "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                        }
                    }
                ],
                "workspaceId": "[resourceId(parameters('logAnalyticsWorkspaceSubscriptionId'), parameters('logAnalyticsWorkspaceResourceGroupName'), 'microsoft.operationalinsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
            }
        }
    ],
    "outputs": {}
}
